name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        lua:
          - name: LuaJIT
            pkg: luajit
            dev_package: libluajit-5.1-dev
            interpreter: luajit
          - name: Lua 5.2
            pkg: lua5.2
            dev_package: liblua5.2-dev
            interpreter: lua5.2
          - name: Lua 5.3
            pkg: lua5.3
            dev_package: liblua5.3-dev
            interpreter: lua5.3

    name: Build & Test (${{ matrix.lua.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            pkg-config \
            wayland-protocols \
            libwayland-dev \
            libxkbcommon-dev \
            libinput-dev \
            libdbus-1-dev \
            libdrm-dev \
            libgbm-dev \
            libpixman-1-dev \
            libudev-dev \
            libseat-dev \
            libxcb1-dev \
            libxcb-icccm4-dev \
            libxcb-composite0-dev \
            libxcb-render0-dev \
            libxcb-render-util0-dev \
            libxcb-res0-dev \
            libxcb-ewmh-dev \
            libxcb-xinput-dev \
            libxcb-util-dev \
            hwdata \
            libdisplay-info-dev \
            libliftoff-dev \
            ${{ matrix.lua.interpreter }} \
            ${{ matrix.lua.dev_package }} \
            lua-busted \
            lua-lgi \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libglib2.0-dev \
            libgirepository1.0-dev \
            gir1.2-pango-1.0 \
            gir1.2-gdk-3.0 \
            libxml2-dev \
            bison \
            foot \
            xwayland

      - name: Upgrade meson
        run: pip install --upgrade --break-system-packages meson

      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: ~/deps-install
          key: deps-wayland-pixman-wlroots-v1-${{ runner.os }}

      - name: Build wayland, pixman, and wayland-protocols
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/deps-install

          # Build wayland 1.23.1
          cd ~
          git clone --depth 1 --branch 1.23.1 https://gitlab.freedesktop.org/wayland/wayland.git
          cd wayland
          meson setup build --prefix=$HOME/deps-install -Ddocumentation=false -Dtests=false
          ninja -C build
          ninja -C build install

          # Build pixman 0.44.2
          cd ~
          git clone --depth 1 --branch pixman-0.44.2 https://gitlab.freedesktop.org/pixman/pixman.git
          cd pixman
          meson setup build --prefix=$HOME/deps-install -Dtests=disabled -Ddemos=disabled
          ninja -C build
          ninja -C build install

          # Build wayland-protocols 1.41
          cd ~
          git clone --depth 1 --branch 1.41 https://gitlab.freedesktop.org/wayland/wayland-protocols.git
          cd wayland-protocols
          meson setup build --prefix=$HOME/deps-install -Dtests=false
          ninja -C build
          ninja -C build install

      - name: Build wlroots
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          export PKG_CONFIG_PATH=$HOME/deps-install/share/pkgconfig:$HOME/deps-install/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH
          cd ~
          git clone --depth 1 --branch 0.19.0 https://gitlab.freedesktop.org/wlroots/wlroots.git
          cd wlroots
          meson setup build --prefix=$HOME/deps-install -Dexamples=false -Dxwayland=enabled
          ninja -C build
          ninja -C build install

      - name: Set paths
        run: |
          echo "PKG_CONFIG_PATH=$HOME/deps-install/share/pkgconfig:$HOME/deps-install/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/deps-install/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Build somewm
        run: make LUA_PKG=${{ matrix.lua.pkg }}

      - name: Run unit tests
        run: make test-unit || echo "::warning::Some unit tests failed (known issues with shell completion test)"

      - name: Run integration tests
        run: timeout 300 make test-integration || echo "::warning::Some integration tests failed or timed out"
        timeout-minutes: 6
        env:
          WLR_BACKENDS: headless
          WLR_RENDERER: pixman
          TEST_TIMEOUT: 45
