name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        wlroots: ['0.18', '0.19']
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            pkg-config \
            wayland-protocols \
            libwayland-dev \
            libxkbcommon-dev \
            libinput-dev \
            libdbus-1-dev \
            libdrm-dev \
            libgbm-dev \
            libpixman-1-dev \
            libudev-dev \
            libseat-dev \
            libxcb1-dev \
            libxcb-icccm4-dev \
            libxcb-composite0-dev \
            libxcb-render0-dev \
            libxcb-render-util0-dev \
            libxcb-res0-dev \
            libxcb-ewmh-dev \
            libxcb-xinput-dev \
            hwdata \
            libdisplay-info-dev \
            libliftoff-dev \
            luajit \
            libluajit-5.1-dev \
            lua-busted \
            lua-lgi \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libglib2.0-dev \
            libgirepository1.0-dev \
            gir1.2-pango-1.0 \
            libxml2-dev \
            foot

      # Upgrade meson via pip (Ubuntu's is too old for c23 support)
      - name: Upgrade meson
        run: |
          pip install --upgrade meson

      - name: Cache wlroots
        id: cache-wlroots
        uses: actions/cache@v4
        with:
          path: ~/wlroots-install
          key: wlroots-${{ matrix.wlroots }}-v3-${{ runner.os }}

      - name: Build wlroots
        if: steps.cache-wlroots.outputs.cache-hit != 'true'
        run: |
          cd ~
          # Full clone needed to get subprojects directory with wrap files
          git clone --branch ${{ matrix.wlroots }}.0 https://gitlab.freedesktop.org/wlroots/wlroots.git
          cd wlroots
          # Use wrap fallback to auto-download missing dependencies (wayland, pixman)
          meson setup build --prefix=$HOME/wlroots-install -Dexamples=false --wrap-mode=forcefallback
          ninja -C build
          ninja -C build install

      - name: Set wlroots paths
        run: |
          echo "PKG_CONFIG_PATH=$HOME/wlroots-install/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/wlroots-install/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Build somewm
        run: make

      - name: Run unit tests
        run: make test-unit

      - name: Run integration tests
        run: |
          # Integration tests run in headless Wayland mode
          # Some tests may be skipped if optional dependencies aren't available
          make test-integration
        env:
          WLR_BACKENDS: headless
          WLR_RENDERER: pixman

  # Separate job for compatibility tests (optional, can be slow)
  compat-tests:
    runs-on: ubuntu-24.04
    needs: build-and-test
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Don't block PRs on compat tests yet

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            pkg-config \
            wayland-protocols \
            libwayland-dev \
            libxkbcommon-dev \
            libinput-dev \
            libdbus-1-dev \
            libdrm-dev \
            libgbm-dev \
            libpixman-1-dev \
            libudev-dev \
            libseat-dev \
            libxcb1-dev \
            libxcb-icccm4-dev \
            libxcb-composite0-dev \
            libxcb-render0-dev \
            libxcb-render-util0-dev \
            libxcb-res0-dev \
            libxcb-ewmh-dev \
            libxcb-xinput-dev \
            hwdata \
            libdisplay-info-dev \
            libliftoff-dev \
            luajit \
            libluajit-5.1-dev \
            lua-busted \
            lua-lgi \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libglib2.0-dev \
            libgirepository1.0-dev \
            gir1.2-pango-1.0 \
            libxml2-dev

      - name: Upgrade meson
        run: pip install --upgrade meson

      - name: Cache wlroots
        id: cache-wlroots
        uses: actions/cache@v4
        with:
          path: ~/wlroots-install
          key: wlroots-0.19-v3-${{ runner.os }}

      - name: Build wlroots
        if: steps.cache-wlroots.outputs.cache-hit != 'true'
        run: |
          cd ~
          git clone --branch 0.19.0 https://gitlab.freedesktop.org/wlroots/wlroots.git
          cd wlroots
          meson setup build --prefix=$HOME/wlroots-install -Dexamples=false --wrap-mode=forcefallback
          ninja -C build
          ninja -C build install

      - name: Set wlroots paths
        run: |
          echo "PKG_CONFIG_PATH=$HOME/wlroots-install/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/wlroots-install/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Build somewm
        run: make

      - name: Run AwesomeWM compatibility tests
        run: make test-compat
        env:
          WLR_BACKENDS: headless
          WLR_RENDERER: pixman
